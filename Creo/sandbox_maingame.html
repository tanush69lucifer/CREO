<html>

<head>
    <meta charset="utf-8">
    <title>creo Game</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <style>
        html, body {
            width:  100%;
            height: 100%;
            margin: 0;
        }
        body {
            font-family: 'Press Start 2P';
            background-color: #000000;
            color: #ffffff;
        }
        h1 {
            padding: 10px;
        }
        #gameDiv { 
            border: 1px solid #ffffff;
            position: absolute;
            left: 50%;
            transform: translate(-50%, -0%);
            -webkit-touch-callout: none; 
                -webkit-user-select: none; 
                -khtml-user-select: none; 
                -moz-user-select: none; 
                    -ms-user-select: none; 
                        user-select: none;
        }
        button, input[type="submit"], input[type="reset"] {
            background: none;
            color: inherit;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }
        #underBox {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -0%);
            margin-top: 10px;
            width: 100%;
        }
        #controls button {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1em;
            text-shadow: 0.5px 1px 4px #000000;
            color: rgba(255, 255, 255, 0.75);
            border: 1px solid #797979;
            margin: 0px 5px 5px 5px;
            font-variant: small-caps;
        }
        #controls button.bright {
            text-shadow: 0.5px 1px 4px #ffffff;
            color: rgba(0, 0, 0, 0.75);   
        }
       
        #controls button:active, #controls button:active:hover {
            filter: brightness(60%);
        }
        #controls button:hover {
            filter: brightness(90%);
        }
        #controls button:disabled {
            cursor: not-allowed;
        }
        #controls button[current="true"], #controls button[on="true"] {
            border: 1px solid #ffffff;
            filter: brightness(110%);
            box-shadow: 0 5px 15px rgba(255, 255, 255, .4);
            color: rgba(255, 255, 255, 1);
        }
        #controls button.bright[current="true"] {
            color: rgba(0, 0, 0, 1);
        }
        #controls button[on="true"] {
            border-color:lime;
            color:lime;
        }
        #controls div {
            display:block;
        }
        .stat {
            margin-right: 25px;
            margin-bottom: 5px;
            float:right;
        }
        #stats {
            margin: 0px 5px 5px 5px;
            font-size: 0.75em;
            height: 2em;
        }
        #stat-pos, #stat-pixels, #stat-shift, #stat-tps, #stat-ticks {
            float:left;
        }

        .chat-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    
    .chatbox {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      background: white;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      overflow: hidden;
      z-index: 999;
    }

    .chatbox-header {
      background-color: orange;
      color: blue;
      padding: 12px;
      font-weight: bold;
      text-align: center;
    }

    .chatbox-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      line-height: 1.4;
    }

    .user {
      background: yellowgreen;
      align-self: flex-end;
      text-align: right;
    }

    .bot {
      background:#797979;
      align-self: flex-start;
      text-align: left;
    }

    .chatbox-input {
      display: flex;
      border-top: 1px solid #ddd;
    }

    .chatbox-input input {
      flex: 1;
      border: none;
      padding: 10px;
      outline: none;
    }

    .chatbox-input button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 15px;
      cursor: pointer;
    }


    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    
    .side-button {
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      z-index: 1000;
    }

    
    .notepad {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 90%;
      background-color: #f9f9f9;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
      padding: 20px;
      transition: right 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      z-index: 999;
    }

    .notepad.open {
      right: 0;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    textarea {
      flex: 1;
      width: 100%;
      resize: none;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .buttons {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
    }

    .buttons button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    .buttons button:hover {
      background-color: #45a049;
    }




    </style>

    <script>
        
        if (!String.prototype.replaceAll) {String.prototype.replaceAll = function(str, newStr){if (Object.prototype.toString.call(str).toLowerCase() === '[object regexp]') {return this.replace(str, newStr);}return this.replace(new RegExp(str, 'g'), newStr);};}
    </script>

    <script>
        
        behaviors = {
            "POWDER": [
                "XX|XX|XX",
                "XX|XX|XX",
                "M2|M1|M2",
            ],
            "AGPOWDER": [
                "M2|M1|M2",
                "XX|XX|XX",
                "XX|XX|XX",
            ],
            "LIQUID": [
                "XX|XX|XX",
                "M2|XX|M2",
                "M2|M1|M2",
            ],
            "WALL": [
                "XX|XX|XX",
                "XX|XX|XX",
                "XX|XX|XX",
            ],
            "UL_UR": [
                "M1|M1|M1",
                "M2|XX|M2",
                "XX|XX|XX",
            ],
            "GAS": [
                "M2|M1|M2",
                "M1|XX|M1",
                "M2|M2|M2",
            ],
            "DGAS": [
                "M2|M1|M2",
                "M1|DL%5|M1",
                "M2|M2|M2",
            ],
            "SUPPORT": [
                "XX|XX|XX",
                "SP|XX|SP",
                "XX|M1|XX",
            ],
            "SUPPORTPOWDER": [
                "XX|XX|XX",
                "SP|XX|SP",
                "M2|M1|M2",
            ],
            "DELETE": [
                "XX|DL|XX",
                "DL|XX|DL",
                "XX|DL|XX",
            ],
            "FILL": [
                "XX|CL|XX",
                "CL|XX|CL",
                "XX|CL|XX",
            ],

        }

        airDensity = 1.225; 
        airTemp = 20; 
        
        elements = {
            "sand": {
                "name": "sand",
                "color": "#e6d577",
                "behavior": behaviors.POWDER,
                "density": 1602,
                "tempHigh": 1700,
                "stateHigh": "molten_glass",
            },

"wet_sand": {
    "name": "wet sand",
    "color": "#c2b280",
    "behavior": behaviors.POWDER,
    "density": 1700,
    "tempHigh": 100, // maybe it dries and becomes sand again
    "stateHigh": "sand"
},




            "water": {
                "name": "water",
                "color": "#2167ff",
                "behavior": behaviors.LIQUID,
                "density": 997,
                "tempHigh": 100,
                "stateHigh": "steam",
                "tempLow": 0,
                "stateLow": "ice",
                "viscosity": 1,
            },
            
            "mossy_rock": {
    "name": "mossy rock",
    "color": "#6b8e23",
    "behavior": behaviors.POWDER,
    "density": 2700,
},

           
            "steam": {
                "name": "steam",
                "color": "#abd6ff",
                "behavior": behaviors.GAS,
                "density": 0.013,
                "temp": 100,
                "tempLow": 95,
                "stateLow": "water",
            },
           
            "snow": {
                "name": "snow",
                "color": "#e1f8fc",
                "behavior": behaviors.POWDER,
                "density": 100,
                "temp": 0,
                "tempHigh": 5,
                "stateHigh": "water",
            },
            "packed_snow": {
                "name": "packed snow",
                "color": "#bcdde3",
                "behavior": behaviors.SUPPORTPOWDER,
                "density": 100,
                "temp": 0,
                "tempHigh": 20,
                "stateHigh": "water",
            },
            "wood": {
                "name": "wood",
                "color": "#a0522d",
                "behavior": behaviors.WALL,
                "density": 745,
                "tempHigh": 230,
                "stateHigh": "fire",
            },
            
            "smoke": {
                "name": "smoke",
                "color": "#383838",
                "behavior": behaviors.DGAS,
                "density": 1180,
                "temp": 114,
                "tempHigh": 605,
                "stateHigh": "fire",
                "deleteAfter": 100,
            },
            "rock": {
                "name": "rock",
                "color": ["#808080","#4f4f4f","#949494"],
                "behavior": behaviors.POWDER,
                "density": 2700,
                "tempHigh": 950,
                "stateHigh": "magma",
            },
            
            "iron": {
                "name": "iron",
                "color": "#cbcdcd",
                "behavior": behaviors.WALL,
                "tempHigh": 1538,
            },
            
           
            
            
           
           
            "water_spout": {
                "name": "water spout",
                "color": "#606378",
                "behavior": [
                    "XX|CR:water|XX",
                    "CR:water|XX|CR:water",
                    "XX|CR:water|XX",
                ],
            },
            
            
            "snow_cloud": {
                "name": "snow cloud",
                "color": "#7e8691",
                "behavior": [
                    "XX|XX|XX",
                    "XX|XX|XX",
                    "XX|CR:packed_snow%1|XX",
                ]
            },
           
            "seed": {
                "name": "seed",
                "color": "#57eb57",
                "behavior": behaviors.POWDER
            },
            
        }

        
        for (var behavior in behaviors) {
            if (typeof behaviors[behavior][0] === "string") {
                var newbehavior = [];
                for (var i = 0; i < behaviors[behavior].length; i++) {
                    newbehavior.push(behaviors[behavior][i].split("|"));
                }
                behaviors[behavior] = newbehavior;
            }
        }

        
        for (element in elements) {
            if (elements[element].tempHigh && !elements[element].stateHigh) {
                var newname = "molten_"+element;
                elements[element].stateHigh = newname;
                elements[newname] = {
                    "name": newname.replaceAll("_"," "),
                    "color": ["#ff6f00","#ff8c00","#ff4d00"],
                    "behavior": behaviors.LIQUID,
                    "density": elements[element].density,
                    "temp": elements[element].tempHigh,
                    "tempLow": elements[element].tempHigh-100,
                    "stateLow": element,
                    "viscosity": 10000,
                    "hidden": true,
                }
            }
            if (elements[element].behavior && typeof elements[element].behavior[0] === "string") {
                var newbehavior = [];
                for (var i = 0; i < elements[element].behavior.length; i++) {
                    newbehavior.push(elements[element].behavior[i].split("|"));
                }
                elements[element].behavior = newbehavior;
            }
        }

        function hexToRGB(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        for (var key in elements) {
            if (elements.hasOwnProperty(key)) {
                
                if (elements[key].color instanceof Array) {
                    var rgbs = [];
                    var rgbos = [];
                    for (var i = 0; i < elements[key].color.length; i++) {
                        var c = elements[key].color[i];
                        if (c.startsWith("#")) {
                            var rgb = hexToRGB(c);
                            rgbs.push("rgb("+rgb.r+","+rgb.g+","+rgb.b+")");
                            rgbos.push(rgb);
                        }
                        else {
                            rgbs.push(c);
                        }
                    }
                    elements[key].color = rgbs;
                    elements[key].colorObject = rgbos;
                } else {
                   
                    if (elements[key].color.startsWith("#")) {
                        var rgb = hexToRGB(elements[key].color);
                        elements[key].color = "rgb("+rgb.r+","+rgb.g+","+rgb.b+")";
                        elements[key].colorObject = rgb;
                    }
                }
            }
        }

        currentPixels = [];
        currentID = 0;
        
        class Pixel {
            constructor(x, y, element) {
                this.x = x;
                this.y = y;
                this.element = element;
                var elementInfo = elements[element];
                this.color = pixelColorPick(this);
                
                if (elementInfo.temp==undefined) {
                    this.temp = airTemp;
                } else {
                    this.temp = elementInfo.temp;
                }
                this.start = pixelTicks;
                this.id = currentID;
                currentID++;
                pixelMap[x][y] = this;
            }
        }
        pixelSize = 10;
        
        function outOfBounds(x,y) {
            
            return y > height-1 || y < 1 || x > width-1 || x < 1
        }
        function isEmpty(x, y, ignoreBounds=false) {
            if (outOfBounds(x,y)) {
                return ignoreBounds;
            }
            return pixelMap[x][y] == undefined;
        }
        function canMove(pixel,x,y) {
            if (isEmpty(x,y)) {
                return true;
            }
        }
        function movePixel(pixel,x,y,leaveBehind=null) {
           
            if (!currentPixels.includes(pixel)) {
                return;
            }
           
            delete pixelMap[pixel.x][pixel.y];
            if (leaveBehind != null) { createPixel(leaveBehind,x,y); }
            pixel.x = x;
            pixel.y = y;
            pixelMap[x][y] = pixel;
        }
        function clonePixel(pixel,x,y) {
            currentPixels.push(new Pixel(x, y, pixel.element));
        }
        function createPixel(element,x,y) {
            currentPixels.push(new Pixel(x, y, element));
        }
        function deletePixel(x,y,id=null) {
            delete pixelMap[x][y];
            if (id != null) {
                for (var i = 0; i < currentPixels.length; i++) {
                    if (currentPixels[i].id == id) {
                        currentPixels.splice(i, 1);
                        return;
                    }
                }
            }
            for (var i = 0; i < currentPixels.length; i++) {
                if (currentPixels[i].x == x && currentPixels[i].y == y) {
                    currentPixels.splice(i, 1);
                    break;
                }
            }
        }
        function swapPixels(pixel1,pixel2) {
            var tempX = pixel1.x;
            var tempY = pixel1.y;
            pixel1.x = pixel2.x;
            pixel1.y = pixel2.y;
            pixel2.x = tempX;
            pixel2.y = tempY;
           
            pixelMap[pixel1.x][pixel1.y] = pixel2;
            pixelMap[pixel2.x][pixel2.y] = pixel1;
        }

        function behaviorCoords(x,y,bx,by) {
            bx -= 1;
            by -= 1;
            x += bx;
            y += by;
            return {x:x,y:y};
        }
       
        function pixelTick(pixel) {
            if (pixel.start == pixelTicks) {return}
            var info = elements[pixel.element];

// Sand and water reaction → wet_sand
if (pixel.element === "sand" || pixel.element === "water") {
    let neighbors = getNeighbors(pixel);
    for (let neighbor of neighbors) {
        if ((pixel.element === "sand" && neighbor.element === "water") ||
            (pixel.element === "water" && neighbor.element === "sand")) {
            pixel.element = "wet_sand";
            pixel.color = pixelColorPick(pixel);
            break;
        }
    }
}

if (pixel.element === "rock") {
    let neighbors = getNeighbors(pixel);
    for (let neighbor of neighbors) {
        if (neighbor.element === "water") {
            pixel.element = "mossy_rock";
            pixel.color = pixelColorPick(pixel);
            break;
        }
    }
}



            var behavior = info.behavior;
            var x = pixel.x;
            var y = pixel.y;
            var move1Spots = [];
            var move2Spots = [];
            var supportSpots = [];
            var replaceSpots = [];
            var deleted = false;
            var leaveBehind = null;
            
            for (var by = 0; by < behavior.length; by++) {
                for (var bx = 0; bx < behavior[by].length; bx++) {
                    var b = behavior[by][bx].trim();
                    var arg = null;
                    if (b.includes(":")) {
                        arg = b.split(":")[1].split(/[\:\%]/)[0];
                        if (!b.includes("%")) {
                            b = b.split(/[\:\%]/)[0];
                        }
                    }
                    
                    if (b.includes("%")) {
                        
                        var chance = parseFloat(b.split("%")[1]);
                        
                        b = b.split(/[\:\%]/)[0];
                    }
                    else { var chance = 100; }
                    if (b == "XX" || b=="") {continue}
                    if (Math.random()*100 < chance) {
                        var newCoords = behaviorCoords(x,y,bx,by);
                        if (b == "M1") {
                            if (!((Math.random()*100) < 100 / ((info.viscosity || 1) ** 0.25))) {
                                newCoords.x = x;
                            }
                            move1Spots.push(newCoords);
                        }
                        else if (b == "M2") {
                            if (!((Math.random()*100) < 100 / ((info.viscosity || 1) ** 0.25))) {
                                newCoords.x = x;
                            }
                            move2Spots.push(newCoords);
                        }
                        else if (b == "SP") {
                            supportSpots.push(newCoords);
                        }
                        else if (b == "DL") {
                            if ((!isEmpty(newCoords.x,newCoords.y)) && !outOfBounds(newCoords.x,newCoords.y)) {
                                
                                if ((!(pixelMap[newCoords.x][newCoords.y].element == pixel.element)) || (newCoords.x == x && newCoords.y == y)) {
                                    if (pixelMap[newCoords.x][newCoords.y].element == arg || arg == null) {
                                        deletePixel(newCoords.x,newCoords.y);
                                        if (newCoords.x == x && newCoords.y == y) {
                                            deleted = true;
                                        }
                                    }
                                }
                            }
                        }
                        else if (b == "CL") {
                            if (isEmpty(newCoords.x,newCoords.y)) {
                                clonePixel(pixel,newCoords.x,newCoords.y);
                            }
                        }
                        
                        else if (b == "CH") {
                            if (!isEmpty(newCoords.x,newCoords.y) && !outOfBounds(newCoords.x,newCoords.y)) {
                                var newPixel = pixelMap[newCoords.x][newCoords.y];
                                newPixel.element = arg;
                                newPixel.color = pixelColorPick(newPixel);
                                newPixel.start = pixelTicks;
                            }
                        }
                       
                        else if (b == "CR") {
                            if (isEmpty(newCoords.x,newCoords.y)) {
                                if (arg == null) {
                                    arg = pixel.element;
                                }
                                else if (arg.includes(",")) {
                                    arg = arg.split(",")[Math.floor(Math.random()*arg.split(",").length)];
                                }
                                createPixel(arg,newCoords.x,newCoords.y);
                            }
                        }
                        
                        else if (b == "LB") {
                            if (arg.includes(",")) {
                                arg = arg.split(",")[Math.floor(Math.random()*arg.split(",").length)];
                            }
                            leaveBehind = arg;
                        }


                    }
                }
            }
            if (deleted) {return;}
            var move = true;
            if (supportSpots.length > 0) {
                var supportCount = 0;
                var allEmpty = true;
                for (var i = 0; i < supportSpots.length; i++) {
                    var bx = supportSpots[i].x;
                    var by = supportSpots[i].y;
                    if (!isEmpty(bx,by)) {
                        supportCount++;
                    }
                }
                if (supportCount == supportSpots.length) {
                    move = false;
                }
            }
           
            

            var moved = false;
            
            if (move) {
                if (move1Spots.length > 0) {
                   
                    while (move1Spots.length > 0) {
                        
                        var coords = move1Spots[Math.floor(Math.random()*move1Spots.length)];
                        var nx = coords.x;
                        var ny = coords.y;
                        if (isEmpty(nx,ny)) { 
                            movePixel(pixel,nx,ny,leaveBehind);
                            moved = true;
                            break;
                        }
                        else {
                            move1Spots.splice(move1Spots.indexOf(coords),1);
                        }
                    }
                }
                
                if (!moved && move2Spots.length > 0) {
                    
                    while (move2Spots.length > 0) {
                        
                        var coords = move2Spots[Math.floor(Math.random()*move2Spots.length)];
                        var nx = coords.x;
                        var ny = coords.y;
                        if (isEmpty(nx,ny)) {
                            movePixel(pixel,nx,ny,leaveBehind);
                            moved = true;
                            break;
                        }
                        else { 
                            move2Spots.splice(move2Spots.indexOf(coords),1);
                        }
                    }
                }
            }

            if (info.tempChange != undefined) {
                pixel.temp += info.tempChange;
                pixelTempCheck(pixel);
            }


        }
        function pixelColorPick(pixel) {
            var element = pixel.element;
            var elementInfo = elements[element];
            if (elementInfo.behavior instanceof Array) {
                var rgb = elements[element].colorObject; 
                
                if (Array.isArray(rgb)) {
                    rgb = rgb[Math.floor(Math.random() * rgb.length)];
                }
              
                var coloroffset = Math.floor(Math.random() * (Math.random() > 0.5 ? -1 : 1) * Math.random() * 15);
                var r = rgb.r + coloroffset;
                var g = rgb.g + coloroffset;
                var b = rgb.b + coloroffset;
                
                r = Math.max(0, Math.min(255, r));
                g = Math.max(0, Math.min(255, g));
                b = Math.max(0, Math.min(255, b));
                var color = "rgb("+r+","+g+","+b+")";
            }
            else {
                var color = elementInfo.color;
                if (Array.isArray(color)) {
                    color = color[Math.floor(Math.random() * color.length)];
                }
            }
            return color;
        }
        function pixelTempCheck(pixel) {
            var elementInfo = elements[pixel.element];
           
            if (pixel.temp >= elementInfo.tempHigh) {
                pixel.element = elementInfo.stateHigh;
                pixel.color = pixelColorPick(pixel);
            }
            
            else if (pixel.temp <= elementInfo.tempLow) {
                pixel.element = elementInfo.stateLow;
                pixel.color = pixelColorPick(pixel);
            }
        }
        function getNeighbors(pixel) {
            var neighbors = [];
            var x = pixel.x;
            var y = pixel.y;
            if (!isEmpty(x-1,y,true)) { neighbors.push(pixelMap[x-1][y]); }
            if (!isEmpty(x+1,y,true)) { neighbors.push(pixelMap[x+1][y]); }
            if (!isEmpty(x,y-1,true)) { neighbors.push(pixelMap[x][y-1]); }
            if (!isEmpty(x,y+1,true)) { neighbors.push(pixelMap[x][y+1]); }
            return neighbors;
        }
        function drawPixels(forceTick=false) {
            var canvas = document.getElementById("game");
            var ctx = canvas.getContext("2d");
           
            var newCurrentPixels = currentPixels.slice();
            newCurrentPixels.sort(function() {return 0.5 - Math.random()});
            for (var i = 0; i < newCurrentPixels.length; i++) {
                pixel = newCurrentPixels[i];
                if (pixelMap[pixel.x][pixel.y] == undefined) {continue}
                if ((!paused) || forceTick) {pixelTick(pixel);};
                ctx.fillStyle = pixel.color;
                ctx.fillRect(pixel.x*10, pixel.y*10, 10, 10);
            }
            if ((!paused) || forceTick) {pixelTicks++};
        }
        function tick() {
            
            if (mouseIsDown) {
                mouseAction(null,mousePos.x,mousePos.y);
            }
            
            var canvas = document.getElementById("game");
            var ctx = canvas.getContext("2d");
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPixels();

            var mouseOffset = Math.trunc(mouseSize/2);
            var topLeft = [mousePos.x-mouseOffset,mousePos.y-mouseOffset];
            var bottomRight = [mousePos.x+mouseOffset,mousePos.y+mouseOffset];
            
            ctx.strokeStyle = "white";
            ctx.strokeRect(topLeft[0]*10,topLeft[1]*10,(bottomRight[0]-topLeft[0]+1)*10,(bottomRight[1]-topLeft[1]+1)*10);
            updateStats();
            ticks ++;
        }
    
        currentElement = "sand";
        mouseIsDown = false;
        mouseType = null;
        function mouseClick(e) {
            mouseIsDown = true;
            
            if (e.button == 0) {
                mouseType = "left";
            }
            else if (e.button == 2) {
                mouseType = "right";
            }
            mouseMove(e);
        }
        function mouseUp(e) {
            mouseIsDown = false;
        }

        function getMousePos(canvas, evt) {
          
            if (evt.touches) {
                evt = evt.touches[0];
            }
            var rect = canvas.getBoundingClientRect();
            return {
                
            x: Math.round((evt.clientX - rect.left)/pixelSize-0.5),
            y: Math.round((evt.clientY - rect.top)/pixelSize-0.5)
            };
        }
        function mouseMove(e) {
            if (mouseIsDown) {
                mouseAction(e);
            }
            else {
                var canvas = document.getElementById("game");
                mousePos = getMousePos(canvas, e);
            }
        }
        function mouseAction(e,mouseX=undefined,mouseY=undefined) {
            if (mouseType == "left") { mouse1Action(e,mouseX,mouseY); }
            else if (mouseType == "right") { mouse2Action(e,mouseX,mouseY); }
        }
        mouseSize = 5;
        mousePos = {x:0,y:0};
        function mouseRange(mouseX,mouseY) {
            var coords = [];
            var mouseOffset = Math.trunc(mouseSize/2);
            var topLeft = [mouseX-mouseOffset,mouseY-mouseOffset];
            var bottomRight = [mouseX+mouseOffset,mouseY+mouseOffset];
            
            for (var x = topLeft[0]; x <= bottomRight[0]; x++) {
                for (var y = topLeft[1]; y <= bottomRight[1]; y++) {
                    
                    coords.push([x,y]);
                }
            }
            return coords;
        }
        function mouse1Action(e,mouseX=undefined,mouseY=undefined) {
          
            if (mouseX == undefined && mouseY == undefined) {
                var canvas = document.getElementById("game");
                var ctx = canvas.getContext("2d");
                mousePos = getMousePos(canvas, e);
                var mouseX = mousePos.x;
                var mouseY = mousePos.y;
            }
            var coords = mouseRange(mouseX,mouseY);
            var element = elements[currentElement];
           
            for (var i = 0; i < coords.length; i++) {
                var x = coords[i][0];
                var y = coords[i][1];

               
                if (currentElement == "heat" || currentElement == "cool") {
                    if (!isEmpty(x,y,false)) {
                        if (outOfBounds(x,y)) {
                            continue;
                        }
                        var pixel = pixelMap[x][y];
                        if (shiftDown) {pixel.temp += element.temp*10;}
                        else {pixel.temp += element.temp;}
                        pixelTempCheck(pixel);
                    }
                }
                else if (placeMode == "replace") {
                    if (outOfBounds(x,y)) {
                        continue;
                    }
                    
                    var index = currentPixels.indexOf(pixelMap[x][y]);
                    if (index > -1) {
                        currentPixels.splice(index, 1);
                    }
                    currentPixels.push(new Pixel(x, y, currentElement));
                }
                else if (isEmpty(x, y)) {
                    currentPixels.push(new Pixel(x, y, currentElement));
                }
            }
        }
        function mouse2Action(e,mouseX=undefined,mouseY=undefined) {
            
            if (mouseX == undefined && mouseY == undefined) {
                var canvas = document.getElementById("game");
                var ctx = canvas.getContext("2d");
                mousePos = getMousePos(canvas, e);
                var mouseX = mousePos.x;
                var mouseY = mousePos.y;
            }
            var coords = mouseRange(mouseX,mouseY);
            
            for (var i = 0; i < coords.length; i++) {
                var x = coords[i][0];
                var y = coords[i][1];

                if (!isEmpty(x, y)) {
                    if (outOfBounds(x,y)) {
                        continue
                    }
                    var pixel = pixelMap[x][y];
                    delete pixelMap[x][y];
                    
                    for (var j = 0; j < currentPixels.length; j++) {
                        if (currentPixels[j].x == x && currentPixels[j].y == y) {
                            currentPixels.splice(j, 1);
                            break;
                        }
                    }
                }
            }
        }

        function selectElement(element) {
            var e1 = document.getElementById("elementButton-"+currentElement)
            if (e1 != null) { e1.setAttribute("current","false"); }
            currentElement = element;
            var e2 = document.getElementById("elementButton-"+element)
            if (e2 != null) { e2.setAttribute("current","true"); }
        }
        function clearAll() {
            currentPixels = [];
            pixelMap = [];
            for (var i = 0; i < width; i++) {
                pixelMap[i] = [];
                for (var j = 0; j < height; j++) {
                    pixelMap[i][j] = undefined;
                }
            }
            pixelTicks = 0;
        }

        
        function updateStats() {
            var statsDiv = document.getElementById("stats");
            statsDiv.innerHTML = "<span id='stat-pos' class='stat'>x"+mousePos.x+",y"+mousePos.y+"</span>";
            statsDiv.innerHTML += "<span id='stat-pixels' class='stat'>Pxls:" + currentPixels.length+"</span>";
            statsDiv.innerHTML += "<span id='stat-tps' class='stat'>" + tps+"tps</span>";
            statsDiv.innerHTML += "<span id='stat-ticks' class='stat'>" + pixelTicks+"</span>";
            if (pixelMap[mousePos.x] != undefined) {
                var currentPixel = pixelMap[mousePos.x][mousePos.y];
                if (currentPixel != undefined) {
                    statsDiv.innerHTML += "<span id='stat-element' class='stat'>Elem:"+currentPixel.element.toUpperCase()+"</span>";
                    statsDiv.innerHTML += "<span id='stat-temperature' class='stat'>Temp:"+currentPixel.temp+"°C</span>";
                }
                if (shiftDown) {
                    statsDiv.innerHTML += "<span id='stat-shift' class='stat'>[↑ ]</span>";
                }
            }
        }

        
        tps = 30;
        tickInterval = window.setInterval(tick, 1000/tps);
        function resetInterval(newtps=30) {
            window.clearInterval(tickInterval);
            tickInterval = window.setInterval(tick, 1000/newtps);
        }
        ticks = 0;
        pixelTicks = 0;

        placeMode = null;
        paused = false;
        function focusGame() { document.getElementById("game").focus(); }
        
        window.onload = function() {
            
            var gameCanvas = document.getElementById("game");
           
            var ctx = gameCanvas.getContext("2d");
            var newWidth  = Math.ceil(window.innerWidth*0.9 / 10) * 10;
            var newHeight = Math.ceil(window.innerHeight*0.675 / 10) * 10;
          
            if (newWidth > 1000) { newWidth = 1000; }
           
            if (window.innerWidth > 1000 && newHeight > 600) { newHeight = 600; }
            ctx.canvas.width = newWidth;
            ctx.canvas.height = newHeight;

            width = Math.round(newWidth/pixelSize)-1;
            height = Math.round(newHeight/pixelSize)-1;
          
            pixelMap = {};
            for (var i = 0; i < width; i++) {
                pixelMap[i] = [];
            }
           
            gameCanvas.addEventListener("mousedown", mouseClick);
            gameCanvas.addEventListener("touchstart", mouseClick);
            gameCanvas.addEventListener("mouseup", mouseUp);
            gameCanvas.addEventListener("touchend", mouseUp);
            gameCanvas.addEventListener("mousemove", mouseMove);
            gameCanvas.addEventListener("touchmove", mouseMove);
            gameCanvas.ontouchstart = function(e) {
                if (e.touches) e = e.touches[0];
                return false;
            }
            shiftDown = false;
          
            document.addEventListener("keydown", function(e) {
                if (e.keyCode == 219) {
                    if (shiftDown) {mouseSize = 1}
                    else {
                        mouseSize -= 2;
                        if (mouseSize < 1) { mouseSize = 1; }
                    }
                }
              
                else if (e.keyCode == 221) {
                    if (shiftDown) {mouseSize = 15}
                    else {mouseSize += 2;}
                   
                    if (mouseSize > (height > width ? height : width)) { mouseSize = (height > width ? height : width); }
                }
                else if (e.keyCode == 16 || e.keyCode == 18) { shiftDown = true; }
                
                else if (e.keyCode == 80) {
                    paused = !paused;
                    if (paused) {
                        document.getElementById("pauseButton").setAttribute("on","true");
                    }
                    else {
                        document.getElementById("pauseButton").setAttribute("on","false");
                    }
                }
            });
           
            document.addEventListener("keyup", function(e) {
                if (e.keyCode == 16 || e.keyCode == 18) { shiftDown = false; }
            });

            
            for (var element in elements) {
                if (elements[element].hidden) { continue; }
                var button = document.createElement("button");
                button.innerHTML = elements[element].name
                
                button.innerHTML = button.innerHTML.replace(".","   ").replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();}).replace("   ",".").replace(/ /g, "");
                
                button.setAttribute("element", element);
                button.setAttribute("current", "false");
                button.className = "elementButton";
                
                if (elements[element].color instanceof Array) {
                    button.style.backgroundImage = "linear-gradient(to bottom right, "+elements[element].color.join(", ")+")";
                }
                else {
                    button.style.background = elements[element].color;
                    var colorObject = elements[element].colorObject;
                    if ((colorObject.r+colorObject.g+colorObject.b)/3 > 200) {
                        button.className += " bright"
                    }
                }
                button.id = "elementButton-" + element;
                button.onclick = function() {
                    selectElement(this.getAttribute("element"));
                }
                document.getElementById("elementControls").appendChild(button);
            }
            selectElement(currentElement);
            focusGame();

        }
    </script>
</head>

<body>
    <h1></h1>
    <img src= "reo.jpg"  alt="">
    <div id="gameDiv">
        <canvas id="game" width="800" height="600" oncontextmenu="return false;">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
        <div id="underDiv">
            <div id="stats"></div>
            <div id="controls">
                <div id="toolControls">
                    <button id="pauseButton" title="Pause/play the simulation" class="controlButton" onclick='if (paused) {paused = false;this.setAttribute("on","false");}else {paused = true;this.setAttribute("on","true");};focusGame();' on="false">Pause</button><button id="frameButton" title="Pause and play one frame" class="controlButton" onclick='if (!paused) {paused=true;document.getElementById("pauseButton").setAttribute("on","true");}drawPixels(true);focusGame();' on="false">Step</button><button id="sizeUpButton" title="Increase the brush size" class="controlButton" onclick="mouseSize+=2;focusGame();">↑</button><button id="sizeDownButton" title="Decrease the brush size" class="controlButton" onclick="mouseSize-=2;focusGame();">↓</button><button id="resetButton" title="Clear the entire scene" class="controlButton" onclick="if (confirm('Are you sure you want to clear the whole scene?')) {clearAll();};focusGame();">Reset</button><button id="replaceButton" title="Override existing pixels when placing" class="controlButton" onclick='if (placeMode == "replace") {placeMode = null;this.setAttribute("on","false");}else {placeMode = "replace";this.setAttribute("on","true");};focusGame();' on="false">Replace</button><button id="elemSelectButton" title="Select an element by ID" class="controlButton" onclick='var e = prompt("Enter the element’s ID").replaceAll(" ","_");if (elements[e] != undefined) {currentElement = e;var btn = document.getElementById("elementButton-"+e);if (btn != null) {btn.setAttribute("current","true");}};focusGame();'>E</button><button id="tpsButton" title="Change the simulation Ticks Per Second (TPS)" class="controlButton" onclick='var newtps = prompt("Enter the new simulation Ticks Per Second (TPS). This is how many updates per second the simulation will run.\n\nThe default is 30.\n\nThe current TPS is " + tps + ".");if (newtps == null || newtps == "" || newtps == "0") {alert("You did not enter a valid TPS. The TPS will be reset.");tps = 30;}else if (newtps > 1000) {alert("You entered a TPS that is too high. The TPS will be set to the maximum, 1000.");tps = 1000;}else {tps = parseInt(newtps);if (isNaN(tps)) {alert("You did not enter a valid TPS. The TPS will be reset.");tps = 30;}}resetInterval(newtps);focusGame();'>TPS</button>
                </div>
                <div id="elementControls"></div>
            </div>
        </div>
    </div>


    <button class="chat-button" onclick="toggleChat()">💬</button>

    
    <div class="chatbox" id="chatbox">
      <div class="chatbox-header">Ask AI</div>
      <div class="chatbox-messages" id="chatMessages"></div>
      <div class="chatbox-input">
        <input type="text" id="userInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>


   
<div class="side-button" onclick="toggleNotepad()">📝 Note</div>


<div class="notepad" id="notepadPanel">
    <h2 id="title" style ="/">My Notepad</h2>
    <script>
      document.getElementById("title").style.color = "black";
    </script>    
  <textarea id="note" placeholder="Write your note here..."></textarea>
  <div class="buttons">
    <button onclick="printNote()">Print</button>
    
    <button onclick="clearNote()">Clear</button>
  </div>
</div>






<script>
    const chatbox = document.getElementById("chatbox");
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userInput");
  
    function toggleChat() {
      chatbox.style.display = chatbox.style.display === "flex" ? "none" : "flex";
    }
  
    function sendMessage() {
      const input = userInput.value.trim();
      if (!input) return;
  
      appendMessage(input, "user");
      userInput.value = "";
      chatMessages.scrollTop = chatMessages.scrollHeight;
  
      
      setTimeout(() => {
        const reply = getAIReply(input);
        appendMessage(reply, "bot");
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 800);
    }
  
    function appendMessage(text, type) {
      const div = document.createElement("div");
      div.className = `message ${type}`;
      div.textContent = text;
      chatMessages.appendChild(div);
    }
  
    function getAIReply(userText) {
      const lower = userText.toLowerCase();
  
      if (lower.includes("hello") || lower.includes("hi")) {
        return "Hey there! How can I help you today?";
      }
      if (lower.includes("rock")) {
        return "Rocks are solid natural substances composed of minerals. They form Earth's crust and are classified into three types: igneous, sedimentary, and metamorphic, based on their origin and formation process";
      }
      
      if (lower.includes("sand")) {
        return "Sand is a granular material made of finely divided rock and mineral particles. It is commonly found on beaches, deserts, and riverbeds, and is widely used in construction and manufacturing.";
      }
      if (lower.includes("seed")) {
        return "A seed is a plant’s reproductive unit, containing an embryo and stored food. It develops from a fertilized ovule and germinates under suitable conditions to grow into a new plant.";
      }
      if (lower.includes("packedsnow")) {
        return "Packed snow forms when snowflakes compress due to wind or pressure, creating a dense, icy layer. It's common in colder climates, aiding activities like skiing but making roads slippery and hazardous.";
      }
      if (lower.includes("waterspout")) {
        return "A waterspout is a rotating column of air and mist that forms over water, resembling a tornado. It can be weak or dangerous, affecting boats and coastal areas with strong winds and heavy rain.";
      }
      if (lower.includes("waterspout")) {
        return "Mossy rocks are vital for ecosystems, providing shelter for small creatures and preventing erosion. They retain moisture, supporting plant life. Their green cover adds beauty and signifies a healthy, humid environment. ";
      }

      if (lower.includes("snowcloud")) {
        return "A snow cloud is a dense cloud carrying ice crystals that produce snowfall. Common in cold climates, it forms from moisture and freezing temperatures, blanketing landscapes in white and impacting visibility and travel.";
      }
      if (lower.includes("snow")) {
        return "Snow is frozen precipitation formed when water vapor condenses into ice crystals in cold air. It falls as soft, white flakes and commonly occurs in winter, covering landscapes with icy beauty.";
      }
      if (lower.includes("smoke")) {
        return "Smoke is a collection of airborne particles and gases released when a material burns. It is often visible, has a distinct odor, and can be harmful to health and the environment.";
      }
      if (lower.includes("steam")) {
        return "Steam is the gaseous form of water produced when water boils at 100°C (212°F). It is used in cooking, heating, and industrial processes due to its heat-carrying properties.";
      }
      
      if (lower.includes("wood")) {
        return "Wood is the hard, fibrous material from trees and plants. It is used as fuel, in construction, furniture, and paper production. Wood is renewable, biodegradable, and has natural strength and beauty.";
      }
      if (lower.includes("iron")) {
        return "Iron is a strong, durable metal commonly found in Earth's crust. It is used in construction, tools, and machinery. Iron is also essential for blood production in living organisms.";
      }
      if (lower.includes("water")) {
        return "Water is a clear, tasteless liquid essential for all life. It covers about 71% of Earth’s surface and is used for drinking, cleaning, agriculture, and industry. It exists in three states.";
      }
     
      if (lower.includes("bye")) {
        return "Goodbye! Come chat again soon.";
      }
  
      return "I'm not sure how to respond to that yet. Try asking me something simple!";
    }
  
   
  </script>

<script>
    function toggleNotepad() {
     const panel = document.getElementById('notepadPanel');
     panel.classList.toggle('open');
   }
 
   function printNote() {
     const content = document.getElementById("note").value;
     const printWin = window.open('', '', 'width=600,height=600');
     printWin.document.write('<pre>' + content + '</pre>');
     printWin.document.close();
     printWin.print();
   }
 
   async function downloadPDF() {
     const { jsPDF } = window.jspdf;
     const doc = new jsPDF();
     const text = document.getElementById("note").value;
     const lines = doc.splitTextToSize(text, 180);
     doc.text(lines, 10, 20);
     doc.save("MyNote.pdf");
   }




 
   function clearNote() {
     document.getElementById("note").value = '';
   }
 </script>





</body>

</html>